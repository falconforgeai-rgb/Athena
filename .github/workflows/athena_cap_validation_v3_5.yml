name: Athena CAP Validation & CGN Commit (v3.5 ‚Äî Evidence Engine Edition)

on:
  workflow_dispatch:
    inputs:
      cap_payload:
        description: "Paste CAP JSON (v3.5-compliant)"
        required: true
  repository_dispatch:
    types:
      [
        cap_validation,
        hic_validation,
        humanization_pass,
        civic_validation,
        decision_trace_commit,
        risk_economics_commit,
        evidence_pack_release,
        baseline_drift_event,
        scenario_redteam_commit
      ]

permissions:
  contents: write

env:
  LEDGER_PATH: "./CGN_LOGS"
  SCHEMA_VERSION: "v3.5"

jobs:
  validate_and_commit:
    name: Validate CHAC+ Record and Commit to CGN Ledger
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout Athena repository
      - name: üß≠ Checkout Athena repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Checkout canonical FalconForge Codex repository
      - name: üß≠ Checkout FalconForge Codex canonical repository
        uses: actions/checkout@v4
        with:
          repository: falconforgeai-rgb/falconforge-codex
          path: codex
          token: ${{ secrets.GH_PAT }}

      # 3Ô∏è‚É£ Define schema + manifest paths dynamically
      - name: üîß Define schema and manifest paths
        run: |
          echo "SCHEMA_PATH=./codex/falconforge-athena-v3_5/canonical/ATHENA_CAP_SCHEMA_v3_5.json" >> $GITHUB_ENV
          echo "INTEGRITY_PATH=./codex/falconforge-athena-v3_5/canonical/FalconForge_Integrity_Manifest_v3_5.json" >> $GITHUB_ENV

      # 4Ô∏è‚É£ Normalize CAP payload input
      - name: üß© Capture CAP payload
        run: |
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo '${{ toJson(github.event.client_payload) }}' > cap_payload_raw.json
          else
            echo '${{ inputs.cap_payload }}' > cap_payload_raw.json
          fi
          jq . cap_payload_raw.json > cap_payload.json
          echo "‚úÖ CAP payload normalized."

      # 5Ô∏è‚É£ Setup Node.js
      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # 6Ô∏è‚É£ Install validator libraries
      - name: üìò Install AJV v8 (JSON Schema 2020-12)
        run: npm install ajv@8 ajv-formats@2

      # 7Ô∏è‚É£ Verify canonical schema integrity via FalconForge manifest
      - name: üîí Verify canonical schema integrity (FalconForge Manifest)
        run: |
          echo "üîç Verifying schema hash integrity (v3.5 unified manifest)..."
          if [ ! -f "$INTEGRITY_PATH" ]; then
            echo "‚ùå Integrity manifest not found at $INTEGRITY_PATH"
            exit 1
          fi
          SCHEMA_HASH=$(sha256sum "$SCHEMA_PATH" | awk '{print $1}')
          EXPECTED_HASH=$(jq -r '.modules[] | select(.name=="ATHENA_CAP_SCHEMA_v3_5.json") | .sha256' "$INTEGRITY_PATH")
          if [ -z "$EXPECTED_HASH" ] || [ "$EXPECTED_HASH" == "null" ]; then
            echo "‚ùå Expected hash not found in manifest."
            exit 1
          fi
          EXPECTED_HASH_CLEAN=$(echo "$EXPECTED_HASH" | sed 's/^SHA256://')
          echo "Manifest Hash : $EXPECTED_HASH_CLEAN"
          echo "Runtime  Hash : $SCHEMA_HASH"
          if [ "$SCHEMA_HASH" != "$EXPECTED_HASH_CLEAN" ]; then
            echo "‚ùå Integrity mismatch! Schema differs from manifest record."
            exit 1
          fi
          echo "‚úÖ Integrity verified ‚Äî schema hash matches FalconForge manifest."

      # 8Ô∏è‚É£ Validate CAP JSON
      - name: üß† Validate CAP JSON (Athena v3.5)
        run: |
          node - <<'EOF'
          import fs from 'fs';
          import Ajv2020 from 'ajv/dist/2020.js';
          import addFormats from 'ajv-formats';
          const ajv = new Ajv2020({ strict: false, allErrors: true });
          addFormats(ajv);
          const schema = JSON.parse(fs.readFileSync(process.env.SCHEMA_PATH));
          const data = JSON.parse(fs.readFileSync('cap_payload.json'));
          const validate = ajv.compile(schema);
          const valid = validate(data);
          if (!valid) {
            console.error('‚ùå Schema validation failed:', validate.errors);
            process.exit(1);
          } else {
            console.log('‚úÖ CAP payload validated successfully.');
          }
          EOF

      # 9Ô∏è‚É£ Generate filename + hash
      - name: üîí Generate canonical filename + SHA256
        id: hash_gen
        run: |
          CAP_ID=$(jq -r '.cap_id // empty' cap_payload.json)
          DOMAIN=$(jq -r '.domain // "unknown"' cap_payload.json | tr '[:upper:]' '[:lower:]')
          YEAR=$(date -u +"%Y")
          MONTH=$(date -u +"%m")
          [ -z "$CAP_ID" ] && { echo "‚ùå cap_id missing"; exit 1; }
          FILEPATH="$LEDGER_PATH/$YEAR/$MONTH/${DOMAIN}_${CAP_ID}.json"
          mkdir -p "$(dirname "$FILEPATH")"
          SHA256=$(sha256sum cap_payload.json | awk '{print $1}')
          echo "file=$FILEPATH" >> $GITHUB_OUTPUT
          echo "hash=$SHA256" >> $GITHUB_OUTPUT
          echo "Generated SHA256: $SHA256"

      # üîü Link previous CGN hash
      - name: ü™∂ Link CGN chain (previous hash)
        run: |
          LAST_FILE=$(find "$LEDGER_PATH" -type f -name "*.json" | sort | tail -n 1 || true)
          PREV_HASH=$(grep -m1 -o 'SHA256:[A-Fa-f0-9]\{64\}' "$LAST_FILE" | head -n 1 || echo "SHA256:NULL")
          jq --arg prev "$PREV_HASH" '.cgn_chain.hash_prev = $prev' cap_payload.json > tmp && mv tmp cap_payload.json
          echo "Linked previous CGN hash: $PREV_HASH"

      # 11Ô∏è‚É£ Verify validator tri-signatures
      - name: üß© Verify tri-signature presence (Ethics, Empathy, Civic)
        run: |
          ETHICS=$(jq -r '.meta.validators.ethics // empty' cap_payload.json)
          EMPATHY=$(jq -r '.meta.validators.empathy // empty' cap_payload.json)
          CIVIC=$(jq -r '.meta.validators.civic // empty' cap_payload.json)
          if [ -z "$ETHICS" ] || [ -z "$EMPATHY" ] || [ -z "$CIVIC" ]; then
            echo "‚ùå Missing validator signature(s)"
            echo "validator_ethics: ${ETHICS:-MISSING}"
            echo "validator_empathy: ${EMPATHY:-MISSING}"
            echo "validator_civic: ${CIVIC:-MISSING}"
            exit 1
          fi
          echo "‚úÖ All validator tri-signatures present."

      # 12Ô∏è‚É£ Commit CHAC+ record to CGN Ledger safely
      - name: üß¨ Commit CHAC+ record to CGN Ledger
        run: |
          FILE="${{ steps.hash_gen.outputs.file }}"
          mkdir -p "$(dirname "$FILE")"
          cp cap_payload.json "$FILE"
          echo "üîπ Preparing commit for file: $FILE"
          git config user.name "Athena-Audit-Bot"
          git config user.email "audit-bot@falconforge.ai"
          git add -f "$FILE"
          git restore --staged cap_payload.json cap_payload_raw.json || true
          if git diff --cached --quiet; then
            echo "‚ö†Ô∏è No new CAP records to commit. Skipping commit."
          else
            git commit -m "Add CHAC+ record: ${{ github.event.client_payload.cap_id }} [${{ steps.hash_gen.outputs.hash }}] (v3.5)"
            git push origin main
            echo "‚úÖ CHAC+ record committed to CGN Ledger."
          fi

      # 13Ô∏è‚É£ Optional Governance Dashboard dispatch
      - name: üåê Dispatch summary to Governance Dashboard (Zapier)
        if: ${{ always() && env.ZAPIER_WEBHOOK_URL != '' }}
        run: |
          SUMMARY=$(jq -n \
            --arg cap_id "$(jq -r '.cap_id' cap_payload.json)" \
            --arg domain "$(jq -r '.domain' cap_payload.json)" \
            --arg status "$(jq -r '.status // \"pending\"' cap_payload.json)" \
            --arg cri "$(jq -r '.cri // \"null\"' cap_payload.json)" \
            --arg cei "$(jq -r '.cei // \"null\"' cap_payload.json)" \
            --arg summary "$(jq -r '.reasoning_summary // \"\"' cap_payload.json)" \
            --arg schema_version "$SCHEMA_VERSION" \
            '{cap_id:$cap_id, domain:$domain, status:$status, cri:$cri, cei:$cei, summary:$summary, schema_version:$schema_version}')
          curl -sS -X POST "$ZAPIER_WEBHOOK_URL" -H "Content-Type: application/json" -d "$SUMMARY" || true

      # 14Ô∏è‚É£ Output verification summary
      - name: üß© Output verification summary
        run: |
          echo "‚úÖ CAP Record successfully processed and verified."
          echo "Schema Version: $SCHEMA_VERSION"
          echo "Record Hash: ${{ steps.hash_gen.outputs.hash }}"
          echo "Chain linked and civic metrics logged."
