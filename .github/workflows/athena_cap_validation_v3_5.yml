name: Athena CAP Validation & CGN Commit (v3.5 ‚Äî Continuous Integrity Edition)

on:
  workflow_dispatch:
    inputs:
      cap_payload:
        description: "Paste CAP JSON (v3.5-compliant)"
        required: true
  repository_dispatch:
    types:
      [
        cap_validation,
        hic_validation,
        humanization_pass,
        civic_validation,
        decision_trace_commit,
        risk_economics_commit,
        evidence_pack_release,
        baseline_drift_event,
        scenario_redteam_commit
      ]
  schedule:
    - cron: "0 3 * * *"  # üï∞Ô∏è Runs every day at 03:00 UTC

permissions:
  contents: write

env:
  LEDGER_PATH: "./CGN_LOGS"
  SCHEMA_VERSION: "v3.5"
  SWEEP_LOG: "./CGN_LOGS/integrity_sweeps"
  BROADCAST_URL: ${{ secrets.FALCONFORGE_GOVERNANCE_WEBHOOK || secrets.ZAPIER_WEBHOOK_URL }}

jobs:
  validate_and_commit:
    name: Validate CAP Record and Commit to CGN Ledger
    runs-on: ubuntu-latest

    steps:
      - name: üß≠ Checkout Athena repository
        uses: actions/checkout@v4

      - name: üß≠ Checkout FalconForge Codex canonical repository
        uses: actions/checkout@v4
        with:
          repository: falconforgeai-rgb/falconforge-codex
          path: codex
          token: ${{ secrets.GH_PAT }}

      - name: üîß Define schema and manifest paths
        run: |
          echo "SCHEMA_PATH=./codex/falconforge-athena-v3_5/canonical/ATHENA_CAP_SCHEMA_v3_5.json" >> $GITHUB_ENV
          echo "INTEGRITY_PATH=./codex/falconforge-athena-v3_5/canonical/FalconForge_Integrity_Manifest_v3_5.json" >> $GITHUB_ENV

      - name: üß© Capture CAP payload
        run: |
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo '${{ toJson(github.event.client_payload) }}' > cap_payload_raw.json
          else
            echo '${{ inputs.cap_payload }}' > cap_payload_raw.json
          fi
          jq . cap_payload_raw.json > cap_payload.json
          echo "‚úÖ CAP payload normalized."

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: üìò Install AJV v8 (JSON Schema 2020-12)
        run: npm install ajv@8 ajv-formats@2

      - name: üîí Verify canonical schema integrity (FalconForge Manifest)
        run: |
          echo "üîç Verifying schema hash integrity..."
          SCHEMA_HASH=$(sha256sum "$SCHEMA_PATH" | awk '{print $1}')
          EXPECTED_HASH=$(jq -r '.modules[] | select(.name=="ATHENA_CAP_SCHEMA_v3_5.json") | .sha256' "$INTEGRITY_PATH" | sed 's/^SHA256://')
          echo "Manifest Hash : $EXPECTED_HASH"
          echo "Runtime  Hash : $SCHEMA_HASH"
          if [ "$SCHEMA_HASH" != "$EXPECTED_HASH" ]; then
            echo "‚ùå Integrity mismatch!"
            exit 1
          fi
          echo "‚úÖ Schema integrity confirmed."

      - name: üß† Validate CAP JSON (Athena v3.5)
        run: |
          node - <<'EOF'
          import fs from 'fs';
          import Ajv2020 from 'ajv/dist/2020.js';
          import addFormats from 'ajv-formats';
          const ajv = new Ajv2020({ strict: false, allErrors: true });
          addFormats(ajv);
          const schema = JSON.parse(fs.readFileSync(process.env.SCHEMA_PATH));
          const data = JSON.parse(fs.readFileSync('cap_payload.json'));
          const validate = ajv.compile(schema);
          const valid = validate(data);
          if (!valid) {
            console.error('‚ùå Schema validation failed:', validate.errors);
            process.exit(1);
          } else {
            console.log('‚úÖ CAP JSON validated successfully.');
          }
          EOF

      - name: üîí Generate canonical filename + SHA256
        id: hash_gen
        run: |
          CAP_ID=$(jq -r '.cap_id // empty' cap_payload.json)
          DOMAIN=$(jq -r '.domain // "unknown"' cap_payload.json | tr '[:upper:]' '[:lower:]')
          YEAR=$(date -u +"%Y")
          MONTH=$(date -u +"%m")
          [ -z "$CAP_ID" ] && { echo "‚ùå cap_id missing"; exit 1; }
          FILEPATH="$LEDGER_PATH/$YEAR/$MONTH/${DOMAIN}_${CAP_ID}.json"
          mkdir -p "$(dirname "$FILEPATH")"
          SHA256=$(sha256sum cap_payload.json | awk '{print $1}')
          echo "file=$FILEPATH" >> $GITHUB_OUTPUT
          echo "hash=$SHA256" >> $GITHUB_OUTPUT

      - name: ü™∂ Link CGN chain (previous hash)
        run: |
          LAST_FILE=$(find "$LEDGER_PATH" -type f -name "*.json" | sort | tail -n 1 || true)
          PREV_HASH=$(grep -m1 -o 'SHA256:[A-Fa-f0-9]\{64\}' "$LAST_FILE" | head -n 1 || echo "SHA256:NULL")
          jq --arg prev "$PREV_HASH" '.cgn_chain.hash_prev = $prev' cap_payload.json > tmp && mv tmp cap_payload.json
          echo "Linked previous CGN hash: $PREV_HASH"

      - name: üß© Verify tri-signature presence (Ethics, Empathy, Civic)
        run: |
          ETHICS=$(jq -r '.meta.validators.ethics // empty' cap_payload.json)
          EMPATHY=$(jq -r '.meta.validators.empathy // empty' cap_payload.json)
          CIVIC=$(jq -r '.meta.validators.civic // empty' cap_payload.json)
          if [ -z "$ETHICS" ] || [ -z "$EMPATHY" ] || [ -z "$CIVIC" ]; then
            echo "‚ùå Missing validator signature(s)"
            exit 1
          fi
          echo "‚úÖ All validator tri-signatures present."

      - name: üß¨ Commit CHAC+ record to CGN Ledger safely
        run: |
          FILE="${{ steps.hash_gen.outputs.file }}"
          mkdir -p "$(dirname "$FILE")"
          cp cap_payload.json "$FILE"
          echo "üîπ Preparing commit for file: $FILE"
          git config user.name "Athena-Audit-Bot"
          git config user.email "audit-bot@falconforge.ai"
          git add -f "$FILE"
          git restore --staged cap_payload.json cap_payload_raw.json || true
          if git diff --cached --quiet; then
            echo "‚ö†Ô∏è No new CAP records to commit."
          else
            git commit -m "Add CHAC+ record: ${{ github.event.client_payload.cap_id }} [${{ steps.hash_gen.outputs.hash }}] (v3.5)"
            git push origin main
            echo "‚úÖ CHAC+ record committed to CGN Ledger."
          fi

      - name: üß¨ Generate CAP Provenance Record
        run: |
          FILE="${{ steps.hash_gen.outputs.file }}"
          PROV_FILE="${FILE%.*}_provenance.json"
          jq -n \
            --arg cap_id "$(jq -r '.cap_id' cap_payload.json)" \
            --arg schema "$SCHEMA_VERSION" \
            --arg root_hash "$(jq -r '.root_hash' $INTEGRITY_PATH)" \
            --arg commit_hash "$(git rev-parse HEAD)" \
            --arg signer "Athena-Audit-Bot" \
            --arg timestamp "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
            '{cap_id:$cap_id, schema:$schema, root_hash:$root_hash, commit:$commit_hash, signer:$signer, timestamp:$timestamp}' > "$PROV_FILE"
          git add -f "$PROV_FILE"
          git commit -m "Add CAP Provenance Record for ${{ github.event.client_payload.cap_id }}"
          git push origin main

      - name: üßÆ CGN Ledger Integrity Sweep + Digest Broadcast
        if: always()
        run: |
          echo "üîç Running CGN Ledger Integrity Sweep..."
          mkdir -p "$SWEEP_LOG"
          SWEEP_REPORT="$SWEEP_LOG/sweep_$(date -u +%Y%m%d_%H%M%S).log"
          ERROR_COUNT=0
          TOTAL_FILES=0
          for f in $(find "$LEDGER_PATH" -type f -name "*.json" | sort); do
            TOTAL_FILES=$((TOTAL_FILES+1))
            HASH_RECORDED=$(sha256sum "$f" | awk '{print $1}')
            FILE_NAME=$(basename "$f")
            CAP_ID=$(jq -r '.cap_id // empty' "$f")
            [ -z "$CAP_ID" ] && { echo "‚ùå Missing cap_id in $FILE_NAME" | tee -a "$SWEEP_REPORT"; ERROR_COUNT=$((ERROR_COUNT+1)); continue; }
            echo "üìÑ [$CAP_ID] ‚Äî Hash: $HASH_RECORDED" | tee -a "$SWEEP_REPORT"
          done
          echo "üîπ Total Records: $TOTAL_FILES" | tee -a "$SWEEP_REPORT"
          DIGEST=$(sha256sum "$SWEEP_REPORT" | awk '{print $1}')
          echo "üîó Sweep Digest: $DIGEST"
          if [ -n "$BROADCAST_URL" ]; then
            jq -n --arg digest "$DIGEST" --arg records "$TOTAL_FILES" --arg errors "$ERROR_COUNT" \
              '{digest:$digest, records:$records, errors:$errors, timestamp:(now|todate)}' \
              | curl -sS -X POST "$BROADCAST_URL" -H "Content-Type: application/json" -d @- || true
          fi
          git config user.name "Athena-Audit-Bot"
          git config user.email "audit-bot@falconforge.ai"
          git add -f "$SWEEP_LOG"
          git commit -m "Add CGN Ledger Integrity Sweep Log ($(date -u +%Y-%m-%dT%H:%M:%SZ))"
          git push origin main || true

  cgn_integrity_cron:
    name: üï∞Ô∏è Daily CGN Integrity Sweep
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: üß≠ Checkout Athena repository
        uses: actions/checkout@v4
      - name: üßÆ Run daily sweep
        run: |
          echo "üï∞Ô∏è Running scheduled CGN Integrity Sweep..."
          bash .github/workflows/athena_cap_validation_v3_5.yml || echo "‚ö†Ô∏è Sweep completed with warnings."
