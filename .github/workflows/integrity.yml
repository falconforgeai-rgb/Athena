name: FalconForge Integrity & CAP Validation
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  verify-schema-integrity:
    name: Verify Athena Canon, Manifest & CAP Payloads
    runs-on: ubuntu-latest

    steps:
      - name: üß© Checkout Athena Repository
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # ------------------------------------------------------------
      # üîÑ Step 1: Sync latest canonical manifest from falconforge-codex
      # ------------------------------------------------------------
      - name: üîÑ Sync Canonical Manifest from Codex
        run: |
          echo "Fetching canonical manifest from falconforge-codex..."
          curl -s -O https://raw.githubusercontent.com/falconforgeai-rgb/falconforge-codex/main/falconforge-athena-v3_5/FalconForge_Integrity_Manifest_v3_5.json
          echo "‚úÖ Canonical manifest synced successfully."

      # ------------------------------------------------------------
      # üîç Step 2: Compute runtime schema hash
      # ------------------------------------------------------------
      - name: üîç Compute Runtime Hash
        id: runtime-hash
        run: |
          FILE="schemas/ATHENA_CAP_SCHEMA_v3_5.json"
          if [ ! -f "$FILE" ]; then
            echo "‚ùå ERROR: $FILE not found."
            exit 1
          fi
          HASH=$(sha256sum "$FILE" | awk '{print $1}')
          echo "runtime_hash=$HASH" >> "$GITHUB_OUTPUT"
          echo "Runtime Hash: $HASH"

      # ------------------------------------------------------------
      # üìú Step 3: Extract canonical hash from synced manifest
      # ------------------------------------------------------------
      - name: üìú Extract Canonical Hash from Manifest
        id: manifest-hash
        run: |
          CANON=$(jq -r '.modules[] | select(.name=="ATHENA_CAP_SCHEMA_v3_5.json") | .sha256' FalconForge_Integrity_Manifest_v3_5.json | sed 's/SHA256://')
          echo "manifest_hash=$CANON" >> "$GITHUB_OUTPUT"
          echo "Manifest Hash: $CANON"

      # ------------------------------------------------------------
      # ‚öñÔ∏è Step 4: Compare hashes
      # ------------------------------------------------------------
      - name: ‚öñÔ∏è Compare Integrity Hashes
        id: compare
        run: |
          echo "Manifest Hash : ${{ steps.manifest-hash.outputs.manifest_hash }}"
          echo "Runtime  Hash : ${{ steps.runtime-hash.outputs.runtime_hash }}"
          if [ "${{ steps.runtime-hash.outputs.runtime_hash }}" != "${{ steps.manifest-hash.outputs.manifest_hash }}" ]; then
            echo "‚ùå Integrity mismatch detected!"
            echo "A schema file has drifted from canonical baseline."
            exit 1
          else
            echo "‚úÖ Integrity verified ‚Äî canonical manifest alignment confirmed."
          fi

      # ------------------------------------------------------------
      # üß™ Step 5: CAP Payload Validation (Zapier / Outbound API)
      # ------------------------------------------------------------
      - name: üß™ Validate CAP Payloads Against Schema
        run: |
          echo "üîé Running CAP payload schema validation..."
          pip install jsonschema
          python3 scripts/validate_cap_payloads.py schemas/ATHENA_CAP_SCHEMA_v3_5.json CAP_LOGS/
          echo "‚úÖ CAP payloads validated successfully."

      # ------------------------------------------------------------
      # üß≠ Step 6: Optional Human-Gated Manifest Sync
      # ------------------------------------------------------------
      - name: üß≠ Human-Gated Manifest Sync
        if: failure() && github.actor == 'YOUR_GITHUB_USERNAME'
        run: |
          echo "‚öôÔ∏è Rebuilding manifest to match updated CAP schema..."
          python3 scripts/update_manifest_hash.py schemas/ATHENA_CAP_SCHEMA_v3_5.json FalconForge_Integrity_Manifest_v3_5.json
          git config user.name "Athena Integrity Bot"
          git config user.email "integrity@falconforge.ai"
          git add FalconForge_Integrity_Manifest_v3_5.json
          git commit -m "Human-gated: Sync CAP schema hash with canonical bundle"
          git push
          echo "‚úÖ Manifest synchronization completed and committed."

      # ------------------------------------------------------------
      # üóÉÔ∏è Step 7: CAP Log Retention & Archival (90-Day Policy)
      # ------------------------------------------------------------
      - name: üóÉÔ∏è Archive CAP Logs Older Than 90 Days
        run: |
          echo "üîí Archiving CAP logs older than 90 days..."
          mkdir -p archive/CAP_LOGS
          find CAP_LOGS -type f -mtime +90 -exec mv {} archive/CAP_LOGS/ \;
          echo "‚úÖ Archived old CAP logs."
          echo "Remaining logs:"
          find CAP_LOGS -type f | wc -l
          echo "Archived logs:"
          find archive/CAP_LOGS -type f | wc -l

      # ------------------------------------------------------------
      # üßæ Step 8: Post-Validation Summary
      # ------------------------------------------------------------
      - name: üßæ Post-Validation Summary
        if: always()
        run: |
          echo "üìò CAP Validation Complete"
          echo "Repository: Athena"
          echo "Advisor-of-Record: HUMAN"
          echo "CAP Log Retention Policy: 90 days"
          echo "Evidence Engine Integrity: $( [ \"${{ job.status }}\" = 'success' ] && echo OK || echo REVIEW_NEEDED )"
