name: FalconForge Athena v3.5 Civic Compliance

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: "0 12 * * 0"   # Weekly on Sunday at 12:00 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  civic-integrity-pipeline:
    name: Athena v3.5 Civic Integrity
    runs-on: ubuntu-latest
    env:
      SCHEMA_PATH: ${{ github.workspace }}/schemas/ATHENA_CAP_SCHEMA_v3_5.json
      MANIFEST_PATH: ${{ github.workspace }}/schemas/FalconForge_Integrity_Manifest_v3_5.json

    steps:
      - name: üß© Checkout Repository
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: üì• Fetch Canonical Schema and Manifest from FalconForge Codex
        run: |
          echo "üîç Fetching canonical schema and manifest from FalconForge Codex..."
          mkdir -p "$GITHUB_WORKSPACE/schemas"
          curl -L --fail -o "$SCHEMA_PATH" \
            "https://raw.githubusercontent.com/falconforgeai-rgb/falconforge-codex/main/falconforge-athena-v3_5/canonical/ATHENA_CAP_SCHEMA_v3_5.json"
          curl -L --fail -o "$MANIFEST_PATH" \
            "https://raw.githubusercontent.com/falconforgeai-rgb/falconforge-codex/main/falconforge-athena-v3_5/canonical/FalconForge_Integrity_Manifest_v3_5.json"
          echo "‚úÖ Canonical schema and manifest pulled from FalconForge Codex"
          echo "üìÇ Listing schemas directory:"
          ls -l "$GITHUB_WORKSPACE/schemas"

      - name: üßÆ Verify Schema Hash Against Manifest
        run: |
          echo "üîç Verifying schema hash integrity..."
          if [ ! -f "$SCHEMA_PATH" ]; then
            echo "‚ùå ERROR: Schema file missing at $SCHEMA_PATH"
            ls -R "$GITHUB_WORKSPACE"
            exit 1
          fi
          MANIFEST_HASH=$(jq -r '.modules[] | select(.name=="ATHENA_CAP_SCHEMA_v3_5.json") | .sha256' "$MANIFEST_PATH" | sed 's/SHA256://')
          RUNTIME_HASH=$(sha256sum "$SCHEMA_PATH" | awk '{print $1}')
          echo "Manifest Hash : $MANIFEST_HASH"
          echo "Runtime  Hash : $RUNTIME_HASH"
          if [ "$MANIFEST_HASH" != "$RUNTIME_HASH" ]; then
            echo "‚ùå Integrity mismatch!"
            exit 1
          fi
          echo "‚úÖ Integrity verified ‚Äî hashes match."

      - name: üß™ Validate CAP Payloads
        run: |
          pip install jsonschema
          if [ -z "$(ls -A CAP_LOGS 2>/dev/null)" ]; then
            echo "‚ö†Ô∏è  No CAP payloads found in CAP_LOGS/. Skipping validation."
            exit 0
          fi
          python3 scripts/validate_cap_payloads.py "$SCHEMA_PATH" CAP_LOGS/

      - name: üîê Check Validator Tri-Signatures
        run: |
          python3 scripts/notify_missing_signatures.py ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: ü©∫ Check CAP Bridge Health
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://athena-cap-bridge.onrender.com/health)
          if [ "$STATUS" != "200" ]; then
            echo "‚ùå CAP Bridge unreachable ($STATUS)"
            exit 1
          fi
          echo "‚úÖ CAP Bridge healthy."

      - name: üß† Compute Civic Drift Metrics
        run: |
          python3 scripts/compute_civic_drift.py CAP_LOGS/

      - name: üì§ Export Decision Trace Ledger
        run: |
          python3 scripts/export_dtl.py CAP_LOGS/ D
