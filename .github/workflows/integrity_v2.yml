name: FalconForge Athena v3.5 Civic Compliance

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: "0 12 * * 0"   # Weekly audit (Sundays at 12:00 UTC)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  civic-integrity-pipeline:
    name: Athena v3.5 Civic Integrity
    runs-on: ubuntu-latest

    env:
      SCHEMA_PATH: ${{ github.workspace }}/schemas/ATHENA_CAP_SCHEMA_v3_5.json
      MANIFEST_PATH: ${{ github.workspace }}/schemas/FalconForge_Integrity_Manifest_v3_5.json
      AWS_REGION: us-east-1

    steps:
      - name: üß© Checkout Repository
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Fetch schema + manifest from private Codex repo
      - name: üì• Fetch Canonical Schema and Manifest from FalconForge Codex
        env:
          CODEX_TOKEN: ${{ secrets.CODEX_READ_TOKEN }}
        run: |
          echo "üîç Fetching canonical schema and manifest from FalconForge Codex..."
          mkdir -p "$GITHUB_WORKSPACE/schemas"

          curl -L -H "Authorization: token $CODEX_TOKEN" \
            -o "$SCHEMA_PATH" \
            "https://raw.githubusercontent.com/falconforgeai-rgb/falconforge-codex/main/falconforge-athena-v3_5/canonical/ATHENA_CAP_SCHEMA_v3_5.json"

          curl -L -H "Authorization: token $CODEX_TOKEN" \
            -o "$MANIFEST_PATH" \
            "https://raw.githubusercontent.com/falconforgeai-rgb/falconforge-codex/main/falconforge-athena-v3_5/canonical/FalconForge_Integrity_Manifest_v3_5.json"

          echo "‚úÖ Canonical schema and manifest pulled successfully."
          ls -l "$GITHUB_WORKSPACE/schemas"

      - name: üßÆ Verify Schema Hash Against Manifest
        run: |
          echo "üîç Verifying schema hash integrity..."
          if [ ! -f "$SCHEMA_PATH" ]; then
            echo "‚ùå ERROR: Schema file missing at $SCHEMA_PATH"
            exit 1
          fi

          pip install jq
          MANIFEST_HASH=$(jq -r '.modules[] | select(.name=="ATHENA_CAP_SCHEMA_v3_5.json") | .sha256' "$MANIFEST_PATH" | sed 's/SHA256://')
          RUNTIME_HASH=$(sha256sum "$SCHEMA_PATH" | awk '{print $1}')
          echo "Manifest Hash : $MANIFEST_HASH"
          echo "Runtime  Hash : $RUNTIME_HASH"

          if [ "$MANIFEST_HASH" != "$RUNTIME_HASH" ]; then
            echo "‚ùå Integrity mismatch!"
            exit 1
          fi
          echo "‚úÖ Integrity verified ‚Äî hashes match."

      - name: üß™ Validate CAP Payloads
        run: |
          pip install jsonschema
          if [ ! -d CAP_LOGS ] || [ -z "$(ls -A CAP_LOGS 2>/dev/null)" ]; then
            echo "‚ö†Ô∏è  No CAP payloads found in CAP_LOGS/. Skipping validation."
            exit 0
          fi
          python3 scripts/validate_cap_payloads.py "$SCHEMA_PATH" CAP_LOGS/

      - name: üîê Check Validator Tri-Signatures
        run: |
          if [ -f scripts/notify_missing_signatures.py ]; then
            python3 scripts/notify_missing_signatures.py ${{ secrets.SLACK_WEBHOOK_URL }}
          else
            echo "‚ÑπÔ∏è No tri-signature notifier script found. Skipping."
          fi

      - name: ü©∫ Check CAP Bridge Health
        run: |
          echo "üîç Checking CAP Bridge health..."
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://athena-cap-bridge.onrender.com/health)
          if [ "$STATUS" != "200" ]; then
            echo "‚ùå CAP Bridge unreachable ($STATUS)"
            exit 1
          fi
          echo "‚úÖ CAP Bridge healthy."

      - name: üß† Compute Civic Drift Metrics
        run: |
          if [ -f scripts/compute_civic_drift.py ]; then
            python3 scripts/compute_civic_drift.py CAP_LOGS/
          else
            echo "‚ÑπÔ∏è No civic drift model found. Skipping drift computation."
          fi

      - name: üì§ Export Decision Trace Ledger
        run: |
          if [ -f scripts/export_dtl.py ]; then
            python3 scripts/export_dtl.py CAP_LOGS/ DTL_EXPORTS/
          else
            echo "‚ÑπÔ∏è No decision trace exporter found. Skipping DTL export."
          fi

      - name: üóÉÔ∏è Archive Old CAP Logs (90 days)
        run: |
          mkdir -p archive/CAP_LOGS
          find CAP_LOGS -type f -mtime +90 -exec mv {} archive/CAP_LOGS/ \; || true
          echo "‚úÖ Logs older than 90 days archived."

      - name: ‚òÅÔ∏è Upload Archive to S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ env.AWS_REGION }}
        run: |
          pip install awscli
          aws s3 sync archive/CAP_LOGS s3://falconforge-athena-archive/CAP_LOGS/ --delete
          echo "‚úÖ Archived CAP logs synced to S3."

      - name: üßæ Generate Weekly Civic Report
        run: |
          if [ -f scripts/generate_civic_report.py ]; then
            python3 scripts/generate_civic_report.py reports/
          else
            echo "‚ÑπÔ∏è No civic report generator found. Skipping."
          fi

          git config user.name "Athena Civic Bot"
          git config user.email "integrity@falconforge.ai"
          git add reports/ || echo "No new reports."
          git commit -m "Add weekly civic compliance report" || echo "Nothing new to commit."
          git push || echo "Push skipped."

      - name: ‚úÖ Final Summary
        if: always()
        run: |
          echo "üèÅ Civic integrity validation pipeline complete."
          echo "üìú Schema integrity checked, CAP payloads validated, and logs archived."
