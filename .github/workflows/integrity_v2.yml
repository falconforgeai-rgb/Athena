name: FalconForge Athena v3.5 Civic Compliance

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: "0 12 * * 0"   # Weekly on Sunday 12:00 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  civic-integrity-pipeline:
    name: Athena v3.5 Civic Integrity
    runs-on: ubuntu-latest

    steps:
      - name: üß© Checkout Repository
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: üì• Fetch Canonical Schema and Manifest from FalconForge Codex
        run: |
          mkdir -p schemas
          echo "üîç Fetching canonical schema and manifest from FalconForge Codex..."
          curl -s -o schemas/ATHENA_CAP_SCHEMA_v3_5.json \
            https://raw.githubusercontent.com/falconforgeai-rgb/falconforge-codex/main/falconforge-athena-v3_5/canonical/ATHENA_CAP_SCHEMA_v3_5.json
          curl -s -o schemas/FalconForge_Integrity_Manifest_v3_5.json \
            https://raw.githubusercontent.com/falconforgeai-rgb/falconforge-codex/main/falconforge-athena-v3_5/canonical/FalconForge_Integrity_Manifest_v3_5.json
          echo "‚úÖ Canonical schema and manifest pulled from FalconForge Codex"

      - name: üßÆ Verify Schema Hash Against Manifest
        run: |
          echo "üîç Verifying schema hash integrity..."
          MANIFEST_HASH=$(jq -r '.modules[] | select(.name=="ATHENA_CAP_SCHEMA_v3_5.json") | .sha256' schemas/FalconForge_Integrity_Manifest_v3_5.json | sed 's/SHA256://')
          RUNTIME_HASH=$(sha256sum schemas/ATHENA_CAP_SCHEMA_v3_5.json | awk '{print $1}')
          echo "Manifest Hash : $MANIFEST_HASH"
          echo "Runtime  Hash : $RUNTIME_HASH"
          if [ "$MANIFEST_HASH" != "$RUNTIME_HASH" ]; then
            echo "‚ùå Integrity mismatch!"
            exit 1
          fi
          echo "‚úÖ Integrity verified ‚Äî hashes match."

      - name: üß™ Validate CAP Payloads
        run: |
          pip install jsonschema
          if [ -z "$(ls -A CAP_LOGS 2>/dev/null)" ]; then
            echo "‚ö†Ô∏è  No CAP payloads found in CAP_LOGS/. Skipping validation."
            exit 0
          fi
          python3 scripts/validate_cap_payloads.py schemas/ATHENA_CAP_SCHEMA_v3_5.json CAP_LOGS/

      - name: üîê Check Validator Tri-Signatures
        run: |
          python3 scripts/notify_missing_signatures.py ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: ü©∫ Check CAP Bridge Health
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://athena-cap-bridge.onrender.com/health)
          if [ "$STATUS" != "200" ]; then
            echo "‚ùå CAP Bridge unreachable ($STATUS)"
            exit 1
          fi
          echo "‚úÖ CAP Bridge healthy."

      - name: üß† Compute Civic Drift Metrics
        run: |
          python3 scripts/compute_civic_drift.py CAP_LOGS/

      - name: üì§ Export Decision Trace Ledger
        run: |
          python3 scripts/export_dtl.py CAP_LOGS/ DTL_EXPORTS/

      - name: üóÉÔ∏è Archive Old CAP Logs (90 days)
        run: |
          mkdir -p archive/CAP_LOGS
          find CAP_LOGS -type f -mtime +90 -exec mv {} archive/CAP_LOGS/ \; || true
          echo "‚úÖ Logs older than 90 days archived."

      - name: ‚òÅÔ∏è Upload Archive to S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-east-1
        run: |
          pip install awscli
          aws s3 sync archive/CAP_LOGS s3://falconforge-athena-archive/CAP_LOGS/ --delete
          echo "‚úÖ Archived CAP logs synced to S3."

      - name: üßæ Generate Weekly Civic Report
        run: |
          python3 scripts/generate_civic_report.py reports/
          git config user.name "Athena Civic Bot"
          git config user.email "integrity@falconforge.ai"
          git add reports/
          git commit -m "Add weekly civic compliance report" || echo "No new report to commit."
          git push

      - name: ‚úÖ Final Summary
        if: always()
        run: |
          echo "üèÅ CAP Validation Complete"
          echo "Slack alerts sent if required."
