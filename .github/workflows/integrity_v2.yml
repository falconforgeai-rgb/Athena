name: Verify Athena Canon, Manifest & CAP Payloads

on:
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: read

jobs:
  civic-integrity:
    runs-on: ubuntu-latest

    steps:
      - name: üß≠ Checkout Athena Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: üß© Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: üîê Install Dependencies
        run: |
          pip install jq jsonschema

      - name: üîÑ Fetch Canonical Manifest from Codex
        env:
          CODEX_TOKEN: ${{ secrets.CODEX_TOKEN }}
        run: |
          echo "üì¶ Fetching FalconForge Canonical Manifest..."
          mkdir -p schemas
          gh auth setup-git
          gh auth status || gh auth login --with-token <<< "${CODEX_TOKEN}"
          gh api \
            repos/falconforgeai-rgb/falconforge-codex/contents/falconforge-athena-v3_5/canonical/FalconForge_Integrity_Manifest_v3_5.json \
            --header "Accept: application/vnd.github.v3.raw" > schemas/FalconForge_Integrity_Manifest_v3_5.json

          echo "‚úÖ Manifest fetched successfully."
          head -n 10 schemas/FalconForge_Integrity_Manifest_v3_5.json || true

      - name: üßÆ Verify Schema Hash Against Manifest
        run: |
          echo "üîç Verifying schema hash integrity..."

          MANIFEST_PATH="schemas/FalconForge_Integrity_Manifest_v3_5.json"
          SCHEMA_PATH="schemas/ATHENA_CAP_SCHEMA_v3_5.json"

          if [ ! -f "$MANIFEST_PATH" ]; then
            echo "‚ùå ERROR: Manifest file missing at $MANIFEST_PATH"
            exit 1
          fi
          if [ ! -f "$SCHEMA_PATH" ]; then
            echo "‚ùå ERROR: Schema file missing at $SCHEMA_PATH"
            exit 1
          fi

          # Clean any BOM or encoding artifacts
          iconv -f utf-8 -t utf-8 "$MANIFEST_PATH" -o "$MANIFEST_PATH"

          echo "üìñ Reading manifest entry for ATHENA_CAP_SCHEMA_v3_5.json"
          MANIFEST_HASH=$(jq -r '
            .modules[]?, .files[]?, .artifacts[]?, .records[]? |
            select(.name=="ATHENA_CAP_SCHEMA_v3_5.json") |
            (.sha256 // .hash // .checksum // empty)
          ' "$MANIFEST_PATH" | sed 's/SHA256://')

          RUNTIME_HASH=$(sha256sum "$SCHEMA_PATH" | awk '{print $1}')

          echo "Manifest Hash : $MANIFEST_HASH"
          echo "Runtime  Hash : $RUNTIME_HASH"

          if [ -z "$MANIFEST_HASH" ]; then
            echo "‚ö†Ô∏è Manifest does not contain an entry for ATHENA_CAP_SCHEMA_v3_5.json"
            exit 1
          fi

          if [ "$MANIFEST_HASH" != "$RUNTIME_HASH" ]; then
            echo "‚ùå Integrity mismatch detected!"
            echo "A schema file has drifted from canonical baseline."
            exit 1
          fi

          echo "‚úÖ Integrity verified ‚Äî hashes match."

      - name: üß† Validate CAP Payload Schema
        run: |
          echo "üîç Validating CAP payload structure..."
          python - <<'PYCODE'
          import json, jsonschema, sys
          with open("schemas/ATHENA_CAP_SCHEMA_v3_5.json") as schema_file:
              schema = json.load(schema_file)
          with open("cap_record.json") as data_file:
              data = json.load(data_file)
          try:
              jsonschema.validate(instance=data, schema=schema)
              print("‚úÖ CAP payload structure is valid.")
          except jsonschema.ValidationError as e:
              print("‚ùå CAP payload validation failed:")
              print(e.message)
              sys.exit(1)
          PYCODE

      - name: ü™∂ Archive Integrity Logs
        if: success() || failure()
        run: |
          mkdir -p archive/CAP_LOGS
          LOG_FILE="archive/CAP_LOGS/integrity_$(date +%Y%m%d_%H%M%S).log"
          echo "Integrity validation completed at $(date -u)" > "$LOG_FILE"
          echo "Result stored in $LOG_FILE"
