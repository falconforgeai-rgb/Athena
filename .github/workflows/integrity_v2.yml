name: Verify Athena Canon, Manifest & CAP Payloads
# Re-register workflow_dispatch trigger for manual run

on:
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: read

jobs:
  civic-integrity:
    runs-on: ubuntu-latest

    steps:
      - name: üß≠ Checkout Athena Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: üß© Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: üîê Install Dependencies
        run: |
          pip install jq jsonschema

      - name: üîÑ Fetch Canonical Manifest from Codex
        run: |
          echo "üì¶ Fetching FalconForge Canonical Manifest..."
          mkdir -p schemas

          # Use raw file endpoint for clean access
          if ! curl -fsSL \
            -o schemas/FalconForge_Integrity_Manifest_v3_5.json \
            "https://raw.githubusercontent.com/falconforgeai-rgb/falconforge-codex/main/falconforge-athena-v3_5/canonical/FalconForge_Integrity_Manifest_v3_5.json"; then
            echo "‚ö†Ô∏è Primary fetch failed ‚Äî retrying via GitHub API..."
            curl -fsSL \
              -H "Accept: application/vnd.github.v3.raw" \
              -o schemas/FalconForge_Integrity_Manifest_v3_5.json \
              "https://api.github.com/repos/falconforgeai-rgb/falconforge-codex/contents/falconforge-athena-v3_5/canonical/FalconForge_Integrity_Manifest_v3_5.json"
          fi

          echo "‚úÖ Manifest fetched successfully."
          head -n 5 schemas/FalconForge_Integrity_Manifest_v3_5.json || echo "‚ö†Ô∏è Manifest preview unavailable."

      - name: üßÆ Verify Schema Hash Against Manifest
        run: |
          echo -e "\033[1;36müîç Verifying schema hash integrity...\033[0m"

          MANIFEST_PATH="schemas/FalconForge_Integrity_Manifest_v3_5.json"
          SCHEMA_PATH="schemas/ATHENA_CAP_SCHEMA_v3_5.json"

          if [ ! -f "$MANIFEST_PATH" ]; then
            echo "‚ùå ERROR: Manifest file missing at $MANIFEST_PATH"
            exit 1
          fi
          if [ ! -f "$SCHEMA_PATH" ]; then
            echo "‚ùå ERROR: Schema file missing at $SCHEMA_PATH"
            exit 1
          fi

          echo "üßπ Pre-validating and sanitizing manifest JSON..."
          python3 - <<'PYCODE'
import sys, json, re
path = "schemas/FalconForge_Integrity_Manifest_v3_5.json"
try:
    text = open(path, 'rb').read().decode('utf-8', errors='ignore')
    text = text.strip().replace('\ufeff', '')
    text = re.sub(r',(\s*[\]}])', r'\1', text)
    data = json.loads(text)
    with open(path, 'w', encoding='utf-8') as f:
        json.dump(data, f, indent=2, ensure_ascii=False)
    print("‚úÖ Manifest JSON validated and cleaned.")
except Exception as e:
    print(f"‚ùå Could not parse manifest JSON: {e}")
    sys.exit(1)
PYCODE

          echo "üìñ Reading manifest entry for ATHENA_CAP_SCHEMA_v3_5.json"
          echo "üßæ Found manifest entries for schema:"
          jq -r '[.modules[]?, .files[]?, .artifacts[]?, .records[]?]
            | map(select(.name=="ATHENA_CAP_SCHEMA_v3_5.json"))' "$MANIFEST_PATH"

         MANIFEST_HASH=$(jq -r '
           [
             (.modules[]?, .files[]?, .artifacts[]?, .records[]?) |
             select(.name=="ATHENA_CAP_SCHEMA_v3_5.json") |
             {hash: (.sha256 // .hash // .checksum // empty), bytes: (.bytes // 0)}
           ]
           | sort_by(.bytes) | last | .hash
           | sub("SHA256:";"") | gsub(" ";"")
         ' "$MANIFEST_PATH")


          RUNTIME_HASH=$(sha256sum "$SCHEMA_PATH" | awk '{print $1}')

          echo "Manifest Hash : $MANIFEST_HASH"
          echo "Runtime  Hash : $RUNTIME_HASH"

          if [ -z "$MANIFEST_HASH" ]; then
            echo "‚ö†Ô∏è Manifest entry not found or invalid for ATHENA_CAP_SCHEMA_v3_5.json"
            exit 1
          fi

          if [ "$MANIFEST_HASH" != "$RUNTIME_HASH" ]; then
            echo -e "\033[1;31m‚ùå Integrity mismatch detected!\033[0m"
            echo "A schema file has drifted from canonical baseline."
            echo "üîé Showing nearby manifest section for context..."
            grep -A5 "ATHENA_CAP_SCHEMA_v3_5.json" "$MANIFEST_PATH" || true
            exit 1
          fi

          echo -e "\033[1;32m‚úÖ Integrity verified ‚Äî hashes match.\033[0m"

      - name: üß† Validate CAP Payload Schema
        run: |
          echo -e "\033[1;36müîç Validating CAP payload structure...\033[0m"
          python - <<'PYCODE'
import json, jsonschema, sys
try:
    with open("schemas/ATHENA_CAP_SCHEMA_v3_5.json") as schema_file:
        schema = json.load(schema_file)
    with open("cap_record.json") as data_file:
        data = json.load(data_file)
    jsonschema.validate(instance=data, schema=schema)
    print("‚úÖ CAP payload structure is valid.")
except FileNotFoundError as e:
    print(f"‚ùå Missing file: {e.filename}")
    sys.exit(1)
except jsonschema.ValidationError as e:
    print("‚ùå CAP payload validation failed:")
    print(e.message)
    sys.exit(1)
except json.decoder.JSONDecodeError as e:
    print(f"‚ùå JSON parsing error: {e}")
    sys.exit(1)
except Exception as e:
    print(f"‚ùå Unexpected error: {e}")
    sys.exit(1)
PYCODE

      - name: ü™∂ Archive Integrity Logs
        if: always()
        run: |
          mkdir -p archive/CAP_LOGS
          LOG_FILE="archive/CAP_LOGS/integrity_$(date +%Y%m%d_%H%M%S).log"
          {
            echo "Integrity validation completed at $(date -u)"
            echo "Manifest path: schemas/FalconForge_Integrity_Manifest_v3_5.json"
            echo "Schema path: schemas/ATHENA_CAP_SCHEMA_v3_5.json"
          } > "$LOG_FILE"
          echo "ü™∂ Result stored in $LOG_FILE"
